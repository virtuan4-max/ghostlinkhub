<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOSTLINK G*MES</title>
    <style>
        :root {
            --neon-blue: #6ecbff;
            --glow: rgba(110, 203, 255, 0.3);
            --bg-black: #000000;
            --terminal-grey: #050505;
            --text-white: #ffffff;
            --font-main: 'Courier New', monospace;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-black);
            color: var(--text-white);
            font-family: var(--font-main);
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
        }

        /* --- HEADER / HUD --- */
        header {
            padding: 10px 25px;
            border-bottom: 1px solid var(--neon-blue);
            box-shadow: 0 0 15px var(--glow);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-black);
            z-index: 100;
        }

        .brand { font-weight: bold; color: var(--neon-blue); text-shadow: 0 0 5px var(--neon-blue); }

        .nav-controls { display: flex; gap: 10px; align-items: center; }

        input, select, .ui-btn {
            background: #000; border: 1px solid var(--neon-blue);
            color: var(--neon-blue); padding: 6px 12px;
            font-family: var(--font-main); outline: none;
            text-transform: uppercase; font-size: 12px;
        }

        .ui-btn { cursor: pointer; transition: 0.2s; }
        .ui-btn:hover { background: var(--glow); box-shadow: 0 0 8px var(--neon-blue); }

        /* --- MAIN AREA --- */
        main { flex: 1; overflow-y: auto; padding: 25px; scrollbar-width: thin; scrollbar-color: var(--neon-blue) #000; }

        details { margin-bottom: 25px; border-left: 1px solid #222; padding-left: 15px; }
        summary { cursor: pointer; padding: 10px 0; color: var(--neon-blue); font-weight: bold; }

        .zone-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .zone-item {
            background: var(--terminal-grey); border: 1px solid #222;
            cursor: pointer; transition: 0.3s; overflow: hidden;
        }

        .zone-item:hover { border-color: var(--neon-blue); box-shadow: 0 0 12px var(--glow); transform: translateY(-2px); }

        .zone-item img { width: 100%; height: 120px; object-fit: cover; opacity: 0.8; }

        .zone-item button {
            width: 100%; background: transparent; border: none;
            color: #fff; font-family: var(--font-main); padding: 12px; 
            cursor: pointer; text-align: center; text-transform: uppercase;
        }

        /* --- ZONE VIEWER --- */
        #zoneViewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000; display: none;
        }

        .viewer-nav {
            display: flex; align-items: center; padding: 10px;
            border-bottom: 1px solid var(--neon-blue); gap: 12px;
            background: #050505;
        }

        #zoneFrame { width: 100%; height: calc(100% - 60px); border: none; }

        /* --- POPUP --- */
        #popupOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }

        .popup-box {
            background: #000; border: 1px solid var(--neon-blue);
            padding: 25px; width: 85%; max-width: 650px;
            box-shadow: 0 0 25px var(--glow);
        }

        /* --- FOOTER --- */
        footer {
            padding: 12px 25px; border-top: 1px solid #111;
            display: flex; justify-content: space-between; font-size: 11px; color: #444;
            background: #000;
        }

        .footer-links span { cursor: pointer; margin-left: 18px; transition: 0.2s; }
        .footer-links span:hover { color: var(--neon-blue); }

        /* --- UTILITY --- */
        .dark-mode { --neon-blue: #a855f7; --glow: rgba(168, 85, 247, 0.3); }
    </style>
</head>
<body onload="listZones()">

    <header>
        <div class="brand">â—ˆ GHOSTLINK // G*MES</div>
        <div class="nav-controls">
            <input type="text" id="searchBar" placeholder="Search..." oninput="filterZones()">
            <select id="filterOptions" onchange="filterZones2()">
                <option value="none">Filter</option>
            </select>
            <select id="sortOptions" onchange="sortZones()">
                <option value="popular">Popular</option>
                <option value="name">Name</option>
                <option value="id">Newest</option>
            </select>
            <button class="ui-btn" id="settings">Settings</button>
        </div>
    </header>

    <main>
        <details id="featuredZonesWrapper" open>
            <summary id="allZonesSummary">Featured G*mes</summary>
            <div id="featuredZones" class="zone-grid"></div>
        </details>

        <details open>
            <summary id="allSummary">All G*mes</summary>
            <div id="container" class="zone-grid">
                </div>
        </details>
    </main>

    <div id="zoneViewer" style="display: none;">
        <div class="viewer-nav">
            <button class="ui-btn" onclick="closeZone()">Close</button>
            <div style="flex-grow: 1; overflow: hidden; white-space: nowrap;">
                <span id="zoneName" style="color: var(--neon-blue); font-weight: bold;"></span> 
                <span id="zoneId" style="font-size: 10px; opacity: 0.3; margin: 0 10px;"></span>
                <a id="zoneAuthor" target="_blank" style="font-size: 11px; color: #888; text-decoration: none;"></a>
            </div>
            <button class="ui-btn" onclick="fullscreenZone()">Fullscreen</button>
            <button class="ui-btn" onclick="aboutBlank()">Open in tab</button>
            <button class="ui-btn" onclick="downloadZone()">Download</button>
        </div>
        <iframe id="zoneFrame"></iframe>
    </div>

    <div id="popupOverlay">
        <div class="popup-box">
            <div style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--neon-blue); padding-bottom: 10px; margin-bottom: 20px;">
                <h2 id="popupTitle" style="margin: 0; font-size: 18px; color: var(--neon-blue);">System Information</h2>
                <button class="ui-btn" onclick="closePopup()">Close</button>
            </div>
            <div id="popupBody" style="max-height: 50vh; overflow-y: auto; line-height: 1.5;"></div>
        </div>
    </div>

    <footer>
        <div>
            <span>Status: Connected</span> 
            <span style="margin-left: 20px; color: #333;">|</span>
            <input type="file" id="loadDataInput" onchange="loadData(event)" style="display:none;">
            <span onclick="document.getElementById('loadDataInput').click()" style="cursor:pointer; margin-left:20px;">Load Data</span>
            <span onclick="saveData()" style="cursor:pointer; margin-left:15px;">Save Data</span>
        </div>
        <div class="footer-links">
            <span onclick="loadPrivacy()">Privacy Policy</span>
            <span onclick="loadDMCA()">DMCA</span>
            <span onclick="showContact()">Contact</span>
        </div>
    </footer>
    <script>
const container = document.getElementById('container');
const zoneViewer = document.getElementById('zoneViewer');
let zoneFrame = document.getElementById('zoneFrame');
const searchBar = document.getElementById('searchBar');
const sortOptions = document.getElementById('sortOptions');
const filterOptions = document.getElementById('filterOptions');
// https://www.jsdelivr.com/tools/purge
const zonesurls = [
    "https://cdn.jsdelivr.net/%67%68/%67%6e%2d%6d%61%74%68/%61%73%73%65%74%73@%6d%61%69%6e/%7a%6f%6e%65%73%2e%6a%73%6f%6e",
    "https://cdn.jsdelivr.net/gh/gn-math/assets@latest/zones.json",
    "https://cdn.jsdelivr.net/gh/gn-math/assets@master/zones.json",
    "https://cdn.jsdelivr.net/gh/gn-math/assets/zones.json"
];
let zonesURL = zonesurls[Math.floor(Math.random() * zonesurls.length)];
const coverURL = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
const htmlURL = "https://cdn.jsdelivr.net/gh/gn-math/html@main";
let zones = [];
let popularityData = {};
const featuredContainer = document.getElementById('featuredZones');
function toTitleCase(str) {
  return str.replace(
    /\w\S*/g,
    text => text.charAt(0).toUpperCase() + text.substring(1).toLowerCase()
  );
}
async function listZones() {
    try {
        let sharesponse, shajson, sha;
        try {
            sharesponse = await fetch("https://api.github.com/repos/gn-math/assets/commits?t=" + Date.now());
            if (sharesponse && sharesponse.status === 200) {
                shajson = await sharesponse.json();
                sha = shajson[0]['sha'];
                if (sha) zonesURL = `https://cdn.jsdelivr.net/gh/gn-math/assets@${sha}/zones.json`;
            }
        } catch (error) {
            try {
                let secondarysha = await fetch("https://raw.githubusercontent.com/gn-math/xml/refs/heads/main/sha.txt?t=" + Date.now());
                if (secondarysha.ok) {
                    sha = (await secondarysha.text()).trim();
                    if (sha) zonesURL = `https://cdn.jsdelivr.net/gh/gn-math/assets@${sha}/zones.json`;
                }
            } catch (e) {}
        }

        const response = await fetch(zonesURL + "?t=" + Date.now());
        const json = await response.json();

        // --- ID & VISIBILITY MANAGEMENT ---
        
        // 1. HIDDEN: Add IDs here to remove them from BOTH Featured and All Games
        const hiddenIds = [-1, 596]; 

        // 2. FEATURED: Add IDs here to show them in the top Featured section
        const featuredIds = [173, 264, 186, 44, 90, 103, 5, 1, 27, 38]; 

        // Apply filtering: This completely removes hidden games from the app
        zones = json.filter(zone => !hiddenIds.includes(zone.id));

        // Assign featured status based on your list
        zones.forEach(zone => {
            zone.featured = featuredIds.includes(zone.id);
        });

        // --- END MANAGEMENT ---

        await fetchPopularity();
        sortZones();

        // Handle URL parameters for direct linking
        const search = new URLSearchParams(window.location.search);
        const id = search.get('id');
        if (id) {
            const zone = zones.find(z => String(z.id) === String(id));
            if (zone) window.location.hash.includes("embed") ? /* embed logic */ null : openZone(zone);
        }

        // Rebuild Tag Filter based on the filtered list
        let alltags = [];
        zones.forEach(z => { if (z.special) alltags.push(...z.special); });
        alltags = [...new Set(alltags)];
        
        let filteroption = document.getElementById("filterOptions");
        if (filteroption) {
            filteroption.innerHTML = '<option value="none">Filter by Tag</option>';
            alltags.forEach(tag => {
                const opt = document.createElement("option");
                opt.value = tag;
                opt.textContent = toTitleCase(tag);
                filteroption.appendChild(opt);
            });
        }
    } catch (error) {
        console.error(error);
        container.innerHTML = `Error loading g*mes: ${error}`;
    }
}
async function fetchPopularity() {
    try {
        const response = await fetch("https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year");
        const data = await response.json();
        data.forEach(file => {
            const idMatch = file.name.match(/\/(\d+)\.html$/);
            if (idMatch) {
                const id = parseInt(idMatch[1]);
                popularityData[id] = file.hits.total;
            }
        });
    } catch (error) {
        popularityData[0] = 0;
    }
}

function sortZones() {
    const sortBy = sortOptions.value;
    if (sortBy === 'name') {
        zones.sort((a, b) => a.name.localeCompare(b.name));
    } else if (sortBy === 'id') {
        zones.sort((a, b) => a.id - b.id);
    } else if (sortBy === 'popular') {
        zones.sort((a, b) => (popularityData[b.id] || 0) - (popularityData[a.id] || 0));
    }
    zones.sort((a, b) => (a.id === -1 ? -1 : b.id === -1 ? 1 : 0));
    if (featuredContainer.innerHTML === "") {
        const featured = zones.filter(z => z.featured);
        displayFeaturedZones(featured);
    }
    displayZones(zones);
}

function displayFeaturedZones(featuredZones) {
    featuredContainer.innerHTML = "";
    featuredZones.forEach((file, index) => {
        const zoneItem = document.createElement("div");
        zoneItem.className = "zone-item";
        zoneItem.onclick = () => openZone(file);
        const img = document.createElement("img");
        img.dataset.src = file.cover.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        img.alt = file.name;
        img.loading = "lazy";
        img.className = "lazy-zone-img";
        zoneItem.appendChild(img);
        const button = document.createElement("button");
        button.textContent = file.name;
        button.onclick = (event) => {
            event.stopPropagation();
            openZone(file);
        };
        zoneItem.appendChild(button);
        featuredContainer.appendChild(zoneItem);
    });
    if (featuredContainer.innerHTML === "") {
        featuredContainer.innerHTML = "No featured G*mes found.";
    } else {
        document.getElementById("allZonesSummary").textContent = `Featured G*mes (${featuredZones.length})`;
    }

    const lazyImages = document.querySelectorAll('#featuredZones img.lazy-zone-img');
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !zoneViewer.hidden) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove("lazy-zone-img");
                observer.unobserve(img);
            }
        });
    }, {
        rootMargin: "100px", 
        threshold: 0.1
    });

    lazyImages.forEach(img => {
        imageObserver.observe(img);
    });
}
function displayZones(zones) {
    container.innerHTML = "";
    zones.forEach((file, index) => {
        const zoneItem = document.createElement("div");
        zoneItem.className = "zone-item";
        zoneItem.onclick = () => openZone(file);
        const img = document.createElement("img");
        img.dataset.src = file.cover.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        img.alt = file.name;
        img.loading = "lazy";
        img.className = "lazy-zone-img";
        zoneItem.appendChild(img);
        const button = document.createElement("button");
        button.textContent = file.name;
        button.onclick = (event) => {
            event.stopPropagation();
            openZone(file);
        };
        zoneItem.appendChild(button);
        container.appendChild(zoneItem);   
    });
    if (container.innerHTML === "") {
        container.innerHTML = "No g*mes found.";
    } else {
        document.getElementById("allSummary").textContent = `All G*mes (${zones.length})`;
    }

    const lazyImages = document.querySelectorAll('img.lazy-zone-img');
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !zoneViewer.hidden) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove("lazy-zone-img");
                observer.unobserve(img);
            }
        });
    }, {
        rootMargin: "100px", 
        threshold: 0.1
    });

    lazyImages.forEach(img => {
        imageObserver.observe(img);
    });
}

function filterZones2() {
    const query = filterOptions.value;
    if (query === "none") {
        displayZones(zones);
    } else {
        const filteredZones = zones.filter(zone => zone.special?.includes(query));
        if (query.length !== 0) {
            document.getElementById("featuredZonesWrapper").removeAttribute("open");
        }
        displayZones(filteredZones);
    }
}

function filterZones() {
    const query = searchBar.value.toLowerCase();
    const filteredZones = zones.filter(zone => zone.name.toLowerCase().includes(query));
    if (query.length !== 0) {
        document.getElementById("featuredZonesWrapper").removeAttribute("open");
    }
    displayZones(filteredZones);
}

function openZone(file) {
    if (file.url.startsWith("http")) {
        window.open(file.url, "_blank");
    } else {
        const url = file.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        fetch(url+"?t="+Date.now()).then(response => response.text()).then(html => {
            if (zoneFrame.contentDocument === null) {
                zoneFrame = document.createElement("iframe");
                zoneFrame.id = "zoneFrame";
                zoneViewer.appendChild(zoneFrame);
            }
            zoneFrame.contentDocument.open();
            zoneFrame.contentDocument.write(html);
            zoneFrame.contentDocument.close();
            document.getElementById('zoneName').textContent = file.name;
            document.getElementById('zoneId').textContent = file.id;
            document.getElementById('zoneAuthor').textContent = "by " + file.author;
            if (file.authorLink) {
                document.getElementById('zoneAuthor').href = file.authorLink;
            }
            zoneViewer.style.display = "block";
            const url = new URL(window.location);
            url.searchParams.set('id', file.id);
            history.pushState(null, '', url.toString());
            zoneViewer.hidden = true;
        }).catch(error => alert("Failed to load zone: " + error));
    }
}

function aboutBlank() {
    const newWindow = window.open("about:blank", "_blank");
    let zone = zones.find(zone => zone.id + '' === document.getElementById('zoneId').textContent).url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
    fetch(zone+"?t="+Date.now()).then(response => response.text()).then(html => {
        if (newWindow) {
            newWindow.document.open();
            newWindow.document.write(html);
            newWindow.document.close();
        }
    })
}

function closeZone() {
    zoneViewer.hidden = false;
    zoneViewer.style.display = "none";
    zoneViewer.removeChild(zoneFrame);
    const url = new URL(window.location);
    url.searchParams.delete('id');
    history.pushState(null, '', url.toString());
}

function downloadZone() {
    let zone = zones.find(zone => zone.id + '' === document.getElementById('zoneId').textContent);
    fetch(zone.url.replace("{HTML_URL}", htmlURL)+"?t="+Date.now()).then(res => res.text()).then(text => {
        const blob = new Blob([text], {
            type: "text/plain;charset=utf-8"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = zone.name + ".html";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
}

function fullscreenZone() {
    if (zoneFrame.requestFullscreen) {
        zoneFrame.requestFullscreen();
    } else if (zoneFrame.mozRequestFullScreen) {
        zoneFrame.mozRequestFullScreen();
    } else if (zoneFrame.webkitRequestFullscreen) {
        zoneFrame.webkitRequestFullscreen();
    } else if (zoneFrame.msRequestFullscreen) {
        zoneFrame.msRequestFullscreen();
    }
}

function sanitizeData(obj, maxStringLen = 1000, maxArrayLen = 10000) {
    if (typeof obj === 'string') {
      return obj.length > maxStringLen ? obj.slice(0, maxStringLen) + '...[truncated]' : obj;
    }
    
    if (obj instanceof Uint8Array) {
      if (obj.length > maxArrayLen) {
        return `[Uint8Array too large (${obj.length} bytes), truncated]`;
      }
      return obj;
    }
    
    if (Array.isArray(obj)) {
      return obj.map(item => sanitizeData(item, maxStringLen, maxArrayLen));
    }
    
    if (obj && typeof obj === 'object') {
      const newObj = {};
      for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
          newObj[key] = sanitizeData(obj[key], maxStringLen, maxArrayLen);
        }
      }
      return newObj;
    }
    
    return obj;
  }

async function saveData() {
    alert("Lock in gooners this doesn't work!!! :/");
    const result = {};
    result.cookies = document.cookie;
    result.localStorage = {...localStorage};
    result.sessionStorage = {...sessionStorage};
    result.indexedDB = {};
    const dbs = await indexedDB.databases();
    for (const dbInfo of dbs) {
      if (!dbInfo.name) continue;
      result.indexedDB[dbInfo.name] = {};
      await new Promise((resolve, reject) => {
        const openRequest = indexedDB.open(dbInfo.name, dbInfo.version);
        openRequest.onerror = () => reject(openRequest.error);
        openRequest.onsuccess = () => {
          const db = openRequest.result;
          const storeNames = Array.from(db.objectStoreNames);
          if (storeNames.length === 0) {
            resolve();
            return;
          }
          const transaction = db.transaction(storeNames, "readonly");
          const storePromises = [];
          for (const storeName of storeNames) {
            result.indexedDB[dbInfo.name][storeName] = [];
            const store = transaction.objectStore(storeName);
            const getAllRequest = store.getAll();
            const p = new Promise((res, rej) => {
              getAllRequest.onsuccess = () => {
                result.indexedDB[dbInfo.name][storeName] = sanitizeData(getAllRequest.result, 1000, 100);
                res();
              };
              getAllRequest.onerror = () => rej(getAllRequest.error);
            });
            storePromises.push(p);
          }
          Promise.all(storePromises).then(() => resolve());
        };
      });
    }

    result.caches = {};
    const cacheNames = await caches.keys();
    for (const cacheName of cacheNames) {
      const cache = await caches.open(cacheName);
      const requests = await cache.keys();
      result.caches[cacheName] = [];
      for (const req of requests) {
        const response = await cache.match(req);
        if (!response) continue;
        const cloned = response.clone();
        const contentType = cloned.headers.get('content-type') || '';
        let body;
        try {
          if (contentType.includes('application/json')) {
            body = await cloned.json();
          } else if (contentType.includes('text') || contentType.includes('javascript')) {
            body = await cloned.text();
          } else {
            const buffer = await cloned.arrayBuffer();
            body = btoa(String.fromCharCode(...new Uint8Array(buffer)));
          }
        } catch (e) {
          body = '[Unable to read body]';
        }
        result.caches[cacheName].push({
          url: req.url,
          body,
          contentType
        });
      }
    }
  
    alert("Done, wait for the download to come");
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([JSON.stringify(result)], {
        type: "application/octet-stream"
    }));
    link.download = `${Date.now()}.data`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
  
  async function loadData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function (e) {
        const data = JSON.parse(e.target.result);
        if (data.cookies) {
            data.cookies.split(';').forEach(cookie => {
              document.cookie = cookie.trim();
            });
          }
        
          if (data.localStorage) {
            for (const key in data.localStorage) {
              localStorage.setItem(key, data.localStorage[key]);
            }
          }
        
          if (data.sessionStorage) {
            for (const key in data.sessionStorage) {
              sessionStorage.setItem(key, data.sessionStorage[key]);
            }
          }
        
          if (data.indexedDB) {
            for (const dbName in data.indexedDB) {
              const stores = data.indexedDB[dbName];
              await new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = e => {
                  const db = e.target.result;
                  for (const storeName in stores) {
                    if (!db.objectStoreNames.contains(storeName)) {
                      db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                    }
                  }
                };
                request.onsuccess = e => {
                  const db = e.target.result;
                  const transaction = db.transaction(Object.keys(stores), 'readwrite');
                  transaction.onerror = () => reject(transaction.error);
                  let pendingStores = Object.keys(stores).length;
        
                  for (const storeName in stores) {
                    const objectStore = transaction.objectStore(storeName);
                    objectStore.clear().onsuccess = () => {
                      for (const item of stores[storeName]) {
                        objectStore.put(item);
                      }
                      pendingStores--;
                      if (pendingStores === 0) resolve();
                    };
                  }
                };
                request.onerror = () => reject(request.error);
              });
            }
          }
        
          if (data.caches) {
            for (const cacheName in data.caches) {
              const cache = await caches.open(cacheName);
              await cache.keys().then(keys => Promise.all(keys.map(k => cache.delete(k)))); // clear existing
        
              for (const entry of data.caches[cacheName]) {
                let responseBody;
                if (entry.contentType.includes('application/json')) {
                  responseBody = JSON.stringify(entry.body);
                } else if (entry.contentType.includes('text') || entry.contentType.includes('javascript')) {
                  responseBody = entry.body;
                } else {
                  const binaryStr = atob(entry.body);
                  const len = binaryStr.length;
                  const bytes = new Uint8Array(len);
                  for (let i = 0; i < len; i++) {
                    bytes[i] = binaryStr.charCodeAt(i);
                  }
                  responseBody = bytes.buffer;
                }
                const headers = new Headers({ 'content-type': entry.contentType });
                const response = new Response(responseBody, { headers });
                await cache.put(entry.url, response);
              }
            }
          }
        alert("Data loaded");
    };
    alert("This might take a while, dont touch anything other than this OK button");
    reader.readAsText(file);
  }

function darkMode() {
    document.body.classList.toggle("dark-mode");
}

function cloakIcon(url) {
    const link = document.querySelector("link[rel~='icon']");
    link.rel = "icon";
    if ((url+"").trim().length === 0) {
        link.href = "favicon.png";
    } else {
        link.href = url;
    }
    document.head.appendChild(link);
}
function cloakName(string) {
    if ((string+"").trim().length === 0) {
        document.title = "gn-math";
        return;
    }
    document.title = string;
}

function tabCloak() {
    closePopup();
    document.getElementById('popupTitle').textContent = "Tab Cloak";
    const popupBody = document.getElementById('popupBody');
    popupBody.innerHTML = `
        <label for="tab-cloak-textbox" style="font-weight: bold;">Set Tab Title:</label><br>
        <input type="text" id="tab-cloak-textbox" placeholder="Enter new tab name..." oninput="cloakName(this.value)">
        <br><br><br><br>
        <label for="tab-cloak-textbox" style="font-weight: bold;">Set Tab Icon:</label><br>
        <input type="text" id="tab-cloak-textbox" placeholder="Enter new tab icon..." oninput='cloakIcon(this.value)'>
        <br><br><br>
    `;
    popupBody.contentEditable = false;
    document.getElementById('popupOverlay').style.display = "flex";
}

const settings = document.getElementById('settings');
settings.addEventListener('click', () => {
    document.getElementById('popupTitle').textContent = "Settings";
    const popupBody = document.getElementById('popupBody');
    popupBody.innerHTML = `
    <button class="settings-button" onclick="darkMode()">Toggle Dark Mode</button>
    <br><br>
    <button class="settings-button" onclick="tabCloak()">Tab Cloak</button>
    <br>
    `;
    popupBody.contentEditable = false;
    document.getElementById('popupOverlay').style.display = "flex";
});

function showContact() {
    document.getElementById('popupTitle').textContent = "Contact";
    const popupBody = document.getElementById('popupBody');
    popupBody.innerHTML = `
    <p>Discord: no discord yet</p>
    <p>Email: no email yet</p>`;
    popupBody.contentEditable = false;
    document.getElementById('popupOverlay').style.display = "flex";
}

function loadPrivacy() {
    document.getElementById('popupTitle').textContent = "Privacy Policy";
    const popupBody = document.getElementById('popupBody');
    popupBody.innerHTML = `
        <div style="max-height: 60vh; overflow-y: auto; text-align: left;">
            <h2>PRIVACY POLICY</h2>
            <p>Last updated: ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
            <p>This Privacy Notice for <strong>GhostLink</strong> ("we," "us," or "our"), describes how and why we might collect or store information when you use our services.</p>
            
            <h3>1. WHAT INFORMATION DO WE COLLECT?</h3>
            <p>We prioritize your privacy. We do not collect any personal identifiers (like names or emails). The only data we process is stored locally on your device to enhance your experience:</p>
            <ul>
                <li><strong>Theme Preferences:</strong> To remember if you prefer light, dark, or custom site themes.</li>
                <li><strong>Game Info:</strong> To save your progress, high scores, or local game settings.</li>
            </ul>
            
            <h3>2. HOW DO WE STORE THIS DATA?</h3>
            <p>This data is typically stored using your browser's <strong>Local Storage</strong> or <strong>Cookies</strong>. This information stays on your device and is not sent to our servers.</p>
            
            <h3>3. THIRD-PARTY SERVICES</h3>
            <p>We do not sell your data or share it with third parties. However, if our site hosts games from external developers, those games may have their own privacy practices once loaded.</p>

            <h3>4. CONTACT US</h3>
            <p>If you have questions about this policy, you can reach us via our Discord: <a href="https://discord.gg/YOUR_LINK_HERE" target="_blank">Join GhostLink Discord</a>.</p>
        </div>
    `;
    popupBody.contentEditable = false;
    document.getElementById('popupOverlay').style.display = "flex";
}

function loadDMCA() {
    document.getElementById('popupTitle').textContent = "DMCA / Content Removal";
    const popupBody = document.getElementById('popupBody');
    popupBody.innerHTML = `
        <div class="dmca-content" style="text-align: left;">
            <p>
                If you are a copyright owner or developer and find your content on <strong>GhostLink</strong> 
                without permission, please reach out so we can remove it promptly.
            </p>
            <ol>
                <li>
                    <strong>Discord (Fastest):</strong> 
                    <a href="https://discord.gg/ will add eventually" target="_blank" rel="noopener noreferrer">
                        Join our Discord
                    </a> and contact an administrator.
                </li>
                <li>
                    <strong>Email:</strong> 
                    <a href="mailto:none">none</a> 
                    with the subject line <code>[DMCA REMOVAL]</code>.
                </li>
            </ol>
            <p>
                <em>Please provide proof of ownership or authorization to act on behalf of the owner to expedite the process.</em>
            </p>
        </div>
    `;
    popupBody.contentEditable = false;
    document.getElementById('popupOverlay').style.display = "flex";
}

let _allStatsCache = null;

async function getAllStats() {
  if (_allStatsCache) {
    return _allStatsCache;
  }

  const BASE_URL =
    "https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files";
  const PERIOD = "year";
  const PAGE_BATCH = 5;

  let page = 1;
  let done = false;
  const combinedMap = Object.create(null);

  while (!done) {
    const pages = Array.from({ length: PAGE_BATCH }, (_, i) => page + i);

    const responses = await Promise.all(
      pages.map(p =>
        fetch(`${BASE_URL}?period=${PERIOD}&page=${p}&limit=100`)
          .then(r => (r.ok ? r.json() : []))
      )
    );

    for (const data of responses) {
      if (!Array.isArray(data) || data.length === 0) {
        done = true;
        break;
      }

      for (const item of data) {
        if (!item?.name) continue;

        const match = item.name.match(/^\/(\d+)([.-])/);
        if (!match) continue;

        const id = match[1];

        if (!combinedMap[id]) {
          combinedMap[id] = {
            hits: 0,
            bandwidth: 0
          };
        }

        combinedMap[id].hits += item.hits?.total ?? 0;
        combinedMap[id].bandwidth += item.bandwidth?.total ?? 0;
      }
    }

    page += PAGE_BATCH;
  }

  _allStatsCache = combinedMap;
  return combinedMap;
}

async function getStats(id) {
  id = String(id);
  const allStats = await getAllStats();

  return allStats[id]?.hits ?? 0;
}

function showZoneInfo() {
    let id = Number(document.getElementById('zoneId').textContent);
    document.getElementById('popupTitle').textContent = "Info";
    const popupBody = document.getElementById('popupBody');
    popupBody.innerHTML = `<p>Loading...</p>`
    popupBody.contentEditable = false;
    document.getElementById('popupOverlay').style.display = "flex";
    fetch(`https://api.github.com/repos/gn-math/html/commits?path=${id}.html`).then(res => res.json()).then(async json => {
        let stats = await getStats (id);
        idjson = zones.filter(a=>a.id===id)[0]
        document.getElementById('popupTitle').textContent = `${idjson.name} Info`;
        const date = new Date(json.at(-1).commit.author.date);
        let formatteddate = new Intl.DateTimeFormat("en-US", {
  month: "long",
  day: "numeric",
  year: "numeric",
  hour: "numeric",
  minute: "2-digit",
  hour12: true
}).format(date);
        popupBody.innerHTML = `
        <p>
        <b>Id</b>: ${id}<br>
        <b>Name</b>: ${idjson.name}<br>
        ${idjson.author?`<b>Game Author</b>: ${idjson.author}<br>`:""}
        ${idjson.authorLink?`<b>Game Author Link</b>: <a style="color:#FFFF00;" href=${idjson.authorLink}>${idjson.authorLink}</a><br>`:""}
        ${idjson.special?`<b>Tags</b>: ${idjson.special}<br>`:""}
        <b>Gn-Math Adder</b>: ${json.at(-1).commit.author.name}<br>
        <b>Date Added</b>: ${formatteddate}<br>
        <b>Times Played (Globally)</b>: ${Number(stats).toLocaleString("en-US")}
        </p>`;
    })
}

function closePopup() {
    document.getElementById('popupOverlay').style.display = "none";
}
listZones();

const schoolList = ["deledao", "goguardian", "lightspeed", "linewize", "securly", ".edu/"];

function isBlockedDomain(url) {
    const domain = new URL(url, location.origin).hostname + "/";
    return schoolList.some(school => domain.includes(school));
}

const originalFetch = window.fetch;
window.fetch = function (url, options) {
    if (isBlockedDomain(url)) {
        console.warn(`lam`);
        return Promise.reject(new Error("lam"));
    }
    return originalFetch.apply(this, arguments);
};

const originalOpen = XMLHttpRequest.prototype.open;
XMLHttpRequest.prototype.open = function (method, url) {
    if (isBlockedDomain(url)) {
        console.warn(`lam`);
        return;
    }
    return originalOpen.apply(this, arguments);
};

HTMLCanvasElement.prototype.toDataURL = function (...args) {
    return "";
};
</script>
    <script>
        const search = new URLSearchParams(window.location.search);
        const privacy = search.get('privacy');
        if (privacy) {
            loadPrivacy();
        }
    </script>
    <script>
        navigator.serviceWorker.register(location.protocol+"//"+location.hostname+"/sw.js");
    </script>
</body>
</html>